name: Terraform Plan (Reusable)

on:
  workflow_call:
    inputs:
      stack_path:
        description: "Terraform stack folder in the CALLER repo (e.g., live/dev/10-vpc). Use '__none__' to no-op."
        required: true
        type: string
      environment:
        description: "Environment name used for tagging/reporting (e.g., dev|stage|prod|global)."
        required: true
        type: string
      aws_region:
        description: "AWS region for provider/backend."
        required: true
        type: string
      terraform_version:
        description: "Terraform version."
        required: true
        type: string
      role_arn:
        description: "AWS IAM role ARN to assume via OIDC (plan role)."
        required: true
        type: string
      state_bucket_name:
        description: "Terraform remote state bucket name."
        required: true
        type: string
      state_kms_key_arn:
        description: "KMS key ARN used for SSE-KMS encryption of state objects."
        required: true
        type: string
      state_key:
        description: "S3 object key for this stack's terraform.tfstate."
        required: true
        type: string
      var_files:
        description: "Optional: newline-separated list of -var-file paths (relative to repo root)."
        required: false
        type: string
        default: ""
      extra_plan_args:
        description: "Optional: extra args appended to terraform plan (e.g., '-target=...')."
        required: false
        type: string
        default: ""

    outputs:
      plan_exitcode:
        description: "0=no changes, 2=changes present"
        value: ${{ jobs.plan.outputs.plan_exitcode }}
      plan_has_changes:
        description: "true if exit code == 2"
        value: ${{ jobs.plan.outputs.plan_has_changes }}

jobs:
  plan:
    name: Plan ${{ inputs.stack_path }}
    runs-on: ubuntu-latest

    # Required for GitHub OIDC token minting. :contentReference[oaicite:1]{index=1}
    permissions:
      id-token: write
      contents: read

    outputs:
      plan_exitcode: ${{ steps.tfplan.outputs.exitcode }}
      plan_has_changes: ${{ steps.tfplan.outputs.has_changes }}

    steps:
      - name: No-op guard
        if: inputs.stack_path == '__none__'
        run: |
          echo "No stacks to plan. Exiting successfully."
          exit 0

      - name: Checkout caller repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ inputs.terraform_version }}
          terraform_wrapper: false

      # Uses GitHub OIDC to assume AWS role. :contentReference[oaicite:2]{index=2}
      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ inputs.role_arn }}
          aws-region: ${{ inputs.aws_region }}
          role-session-name: gha-tf-plan-${{ github.run_id }}

      - name: Write backend.hcl (ephemeral)
        working-directory: ${{ inputs.stack_path }}
        run: |
          cat > backend.hcl <<EOF
          bucket       = "${{ inputs.state_bucket_name }}"
          key          = "${{ inputs.state_key }}"
          region       = "${{ inputs.aws_region }}"
          encrypt      = true
          kms_key_id   = "${{ inputs.state_kms_key_arn }}"
          use_lockfile = true
          EOF

      - name: Terraform fmt (stack only)
        working-directory: ${{ inputs.stack_path }}
        run: terraform fmt -check

      - name: Terraform init
        working-directory: ${{ inputs.stack_path }}
        env:
          TF_IN_AUTOMATION: "true"
        run: terraform init -reconfigure -backend-config=backend.hcl

      - name: Terraform validate
        working-directory: ${{ inputs.stack_path }}
        env:
          TF_IN_AUTOMATION: "true"
        run: terraform validate

      - name: Terraform plan (detailed exit code)
        id: tfplan
        working-directory: ${{ inputs.stack_path }}
        env:
          TF_IN_AUTOMATION: "true"
        shell: bash
        run: |
          set -euo pipefail
          
          pwd
          ls -la
          # Build optional -var-file args
          VAR_ARGS=()
          if [[ -n "${{ inputs.var_files }}" ]]; then
            while IFS= read -r f; do
              [[ -z "$f" ]] && continue
              VAR_ARGS+=("-var-file=$GITHUB_WORKSPACE/$f")
            done <<< "${{ inputs.var_files }}"
          fi

          set +e
          terraform plan \
            -input=false \
            -lock-timeout=5m \
            -detailed-exitcode \
            -out=tfplan \
            "${VAR_ARGS[@]}" \
            ${{ inputs.extra_plan_args }}
          code=$?
          set -e

          if [[ $code -eq 1 ]]; then
            echo "Terraform plan failed."
            exit 1
          fi

          echo "exitcode=$code" >> "$GITHUB_OUTPUT"
          if [[ $code -eq 2 ]]; then
            echo "has_changes=true" >> "$GITHUB_OUTPUT"
          else
            echo "has_changes=false" >> "$GITHUB_OUTPUT"
          fi

          terraform show -no-color tfplan > tfplan.txt

      - name: Upload plan artifacts
        uses: actions/upload-artifact@v4
        with:
          name: tfplan-${{ github.event.repository.name }}-${{ inputs.environment }}-${{ inputs.stack_path }}
          path: |
            ${{ inputs.stack_path }}/tfplan
            ${{ inputs.stack_path }}/tfplan.txt
