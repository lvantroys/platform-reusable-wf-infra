name: Terraform Apply (Reusable)

on:
  workflow_call:
    inputs:
      stack_path:
        description: "Terraform stack folder in the CALLER repo (e.g., live/prod/20-edge)."
        required: true
        type: string
      environment:
        description: "GitHub Environment name (dev|stage|prod|global). Approvals should be configured in THIS repo."
        required: true
        type: string
      aws_region:
        description: "AWS region for provider/backend."
        required: true
        type: string
      terraform_version:
        description: "Terraform version."
        required: true
        type: string
      role_arn:
        description: "AWS IAM role ARN to assume via OIDC (apply role)."
        required: true
        type: string
      state_bucket_name:
        description: "Terraform remote state bucket name."
        required: true
        type: string
      state_kms_key_arn:
        description: "KMS key ARN used for SSE-KMS encryption of state objects."
        required: true
        type: string
      state_key:
        description: "S3 object key for this stack's terraform.tfstate."
        required: true
        type: string
      var_files:
        description: "Optional: newline-separated list of -var-file paths (relative to repo root)."
        required: false
        type: string
        default: ""
      extra_plan_args:
        description: "Optional: extra args appended to terraform plan."
        required: false
        type: string
        default: ""
      require_main_branch:
        description: "If true, fail unless caller run is on refs/heads/main."
        required: false
        type: boolean
        default: true

jobs:
  apply:
    name: Apply ${{ inputs.stack_path }}
    runs-on: ubuntu-latest

    # This is where you enforce approvals: create environments (dev/stage/prod) in THIS repo.
    environment: ${{ inputs.environment }}

    # Prevent two applies to the same stack at once. :contentReference[oaicite:3]{index=3}
    concurrency:
      group: tf-apply-${{ inputs.environment }}-${{ inputs.stack_path }}
      cancel-in-progress: false

    permissions:
      id-token: write
      contents: read

    steps:
      - name: Guard: require main branch (optional)
        if: inputs.require_main_branch && github.ref != 'refs/heads/main'
        run: |
          echo "Apply restricted to refs/heads/main. Current ref: $GITHUB_REF"
          exit 1

      - name: Checkout caller repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ inputs.terraform_version }}
          terraform_wrapper: false

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ inputs.role_arn }}
          aws-region: ${{ inputs.aws_region }}
          role-session-name: gha-tf-apply-${{ github.run_id }}

      - name: Write backend.hcl (ephemeral)
        working-directory: ${{ inputs.stack_path }}
        run: |
          cat > backend.hcl <<EOF
          bucket       = "${{ inputs.state_bucket_name }}"
          key          = "${{ inputs.state_key }}"
          region       = "${{ inputs.aws_region }}"
          encrypt      = true
          kms_key_id   = "${{ inputs.state_kms_key_arn }}"
          use_lockfile = true
          EOF

      - name: Terraform init
        working-directory: ${{ inputs.stack_path }}
        env:
          TF_IN_AUTOMATION: "true"
        run: terraform init -reconfigure -backend-config=backend.hcl

      - name: Terraform plan (apply gate)
        working-directory: ${{ inputs.stack_path }}
        env:
          TF_IN_AUTOMATION: "true"
        shell: bash
        run: |
          set -euo pipefail

          VAR_ARGS=()
          if [[ -n "${{ inputs.var_files }}" ]]; then
            while IFS= read -r f; do
              [[ -z "$f" ]] && continue
              VAR_ARGS+=("-var-file=$GITHUB_WORKSPACE/$f")
            done <<< "${{ inputs.var_files }}"
          fi

          terraform plan \
            -input=false \
            -lock-timeout=5m \
            -out=tfplan \
            "${VAR_ARGS[@]}" \
            ${{ inputs.extra_plan_args }}

      - name: Terraform apply
        working-directory: ${{ inputs.stack_path }}
        env:
          TF_IN_AUTOMATION: "true"
        run: terraform apply -input=false -auto-approve tfplan

